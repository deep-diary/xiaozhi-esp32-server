@startuml 连接状态转换
!theme plain

[*] --> 等待连接

等待连接 --> 已连接 : WebSocket连接
已连接 --> 初始化中 : 开始初始化
初始化中 --> 就绪 : 初始化完成

就绪 --> 处理音频 : 收到音频数据
就绪 --> 处理文本 : 收到文本消息

处理音频 --> VAD检测 : 音频数据
VAD检测 --> ASR识别 : 检测到语音
VAD检测 --> 检查超时 : 未检测到语音
检查超时 --> 就绪 : 未超时
检查超时 --> 关闭连接 : 超时

ASR识别 --> 意图识别 : 识别完成
处理文本 --> 意图识别 : 文本消息

意图识别 --> LLM处理 : 需要LLM处理
意图识别 --> 工具调用 : 需要调用工具
意图识别 --> 直接回复 : 直接回复

工具调用 --> LLM处理 : Action=REQLLM
工具调用 --> 直接回复 : Action=RESPONSE

LLM处理 --> TTS合成 : 生成文本
直接回复 --> TTS合成 : 回复文本

TTS合成 --> 发送音频 : 合成完成
发送音频 --> 就绪 : 发送完成

就绪 --> 关闭连接 : 用户退出/超时/错误
关闭连接 --> [*] : 清理完成

@enduml

