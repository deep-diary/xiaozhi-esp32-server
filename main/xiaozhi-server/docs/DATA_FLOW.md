# 小智服务器数据流详解

本文档详细描述了小智服务器中各种数据流的处理过程。

## 一、音频输入数据流

### 1.1 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  客户端 (ESP32)                                              │
│  发送音频数据 (Opus 编码)                                     │
└──────────────────────┬──────────────────────────────────────┘
                       │ WebSocket (bytes)
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  ConnectionHandler.handle_connection()                      │
│  └─→ async for message in websocket                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  ConnectionHandler._route_message()                         │
│  ├─→ isinstance(message, bytes) ?                           │
│  └─→ 是 → 进入音频处理流程                                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  receiveAudioHandle.handleAudioMessage()                     │
│  ├─→ conn.vad.is_vad(conn, audio)  # VAD检测                │
│  │   ├─→ 检测到语音                                           │
│  │   │   ├─→ 更新 conn.last_activity_time                   │
│  │   │   └─→ 如果正在播放，触发中断 (handleAbortMessage)     │
│  │   └─→ 未检测到语音                                         │
│  │       └─→ 检查超时 (no_voice_close_connect)              │
│  │                                                           │
│  └─→ conn.asr.receive_audio(conn, audio, have_voice)       │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  流式 ASR        │        │  非流式 ASR       │
│  (Stream)        │        │  (Batch)          │
│                  │        │                  │
│  - 实时识别      │        │  - 等待完整音频   │
│  - 部分结果      │        │  - 一次性识别     │
│  - 回调通知      │        │  - 完整结果返回   │
└────────┬─────────┘        └────────┬─────────┘
         │                           │
         └───────────┬───────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  ASR 识别完成回调                                            │
│  └─→ startToChat(conn, text)                                │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  startToChat()                                               │
│  ├─→ 检查设备绑定状态                                         │
│  ├─→ 检查输出字数限制                                         │
│  ├─→ 处理中断逻辑                                             │
│  ├─→ handle_user_intent()  # 意图识别                        │
│  │   └─→ 特殊意图处理 (退出、播放音乐等)                      │
│  └─→ chat()  # 常规对话                                      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 关键数据结构

#### 音频数据
- **格式**: Opus 编码的二进制数据
- **传输**: WebSocket bytes 消息
- **缓冲**: `conn.client_audio_buffer` (VAD 检测用)
- **队列**: `conn.asr_audio_queue` (ASR 处理用)

#### VAD 检测结果
```python
have_voice: bool  # 是否检测到语音
```

## 二、文本输入数据流

### 2.1 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  客户端发送文本消息 (JSON 格式)                               │
│  {"type": "xxx", "content": "..."}                          │
└──────────────────────┬──────────────────────────────────────┘
                       │ WebSocket (str)
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  ConnectionHandler._route_message()                         │
│  ├─→ isinstance(message, str) ?                             │
│  └─→ 是 → 进入文本处理流程                                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  textHandle.handleTextMessage()                             │
│  └─→ TextMessageProcessor.process_message()                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  TextMessageProcessor.process_message()                     │
│  ├─→ json.loads(message)  # 解析 JSON                       │
│  ├─→ 提取 message_type                                      │
│  └─→ 路由到对应处理器                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  hello            │        │  listen           │
│  Handler          │        │  Handler          │
│  - 问候消息       │        │  - 切换监听模式   │
└──────────────────┘        └──────────────────┘
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  iot             │        │  mcp              │
│  Handler         │        │  Handler          │
│  - IoT设备控制    │        │  - MCP工具调用    │
└──────────────────┘        └──────────────────┘
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  server           │        │  abort            │
│  Handler          │        │  Handler          │
│  - 服务器控制     │        │  - 中断当前操作   │
└──────────────────┘        └──────────────────┘
```

### 2.2 消息类型说明

| 消息类型 | 处理器 | 说明 |
|---------|--------|------|
| `hello` | HelloMessageHandler | 问候消息，初始化连接 |
| `listen` | ListenMessageHandler | 切换监听模式 (auto/manual) |
| `iot` | IoTMessageHandler | IoT 设备控制消息 |
| `mcp` | MCPMessageHandler | MCP 工具调用消息 |
| `server` | ServerMessageHandler | 服务器控制消息 (重启等) |
| `abort` | AbortMessageHandler | 中断当前操作 |

## 三、LLM 对话数据流

### 3.1 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  ConnectionHandler.chat(query, depth=0)                     │
│  ├─→ 创建 sentence_id (UUID)                                │
│  ├─→ 设置 llm_finish_task = False                          │
│  └─→ dialogue.put(Message(role="user", content=query))     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  查询记忆 (可选)                                             │
│  └─→ memory.query_memory(query)                            │
│      └─→ 返回相关记忆上下文                                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  构建对话上下文                                              │
│  └─→ dialogue.get_llm_dialogue_with_memory()                │
│      ├─→ 系统提示词                                          │
│      ├─→ 记忆上下文                                          │
│      └─→ 对话历史                                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  有 Function     │        │  无 Function     │
│  Call 支持       │        │  Call            │
│                  │        │                  │
│  llm.response_   │        │  llm.response()  │
│  with_functions()│        │                  │
└────────┬─────────┘        └────────┬─────────┘
         │                           │
         └───────────┬───────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  LLM 流式响应处理                                            │
│  └─→ for response in llm_responses:                        │
│      ├─→ 普通文本响应                                        │
│      │   ├─→ response_message.append(content)                │
│      │   └─→ TTS 入队 (SentenceType.MIDDLE)                 │
│      │                                                       │
│      └─→ Function Call 响应                                  │
│          ├─→ 收集 tool_calls                                 │
│          └─→ 标记 tool_call_flag = True                     │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  有工具调用       │        │  无工具调用      │
│                  │        │                  │
│  _handle_        │        │  保存对话历史     │
│  function_result()│       │  dialogue.put()  │
└────────┬─────────┘        └────────┬─────────┘
         │                           │
         ▼                           ▼
┌─────────────────────────────────────────────────────────────┐
│  工具调用处理                                                │
│  └─→ UnifiedToolHandler.handle_llm_function_call()       │
│      ├─→ 解析工具名称和参数                                   │
│      ├─→ 执行工具                                            │
│      └─→ 根据 Action 决定后续处理                            │
│          ├─→ Action.RESPONSE → 直接回复                      │
│          └─→ Action.REQLLM → 递归调用 chat(depth+1)         │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 对话历史结构

```python
class Dialogue:
    dialogue: List[Message]  # 对话消息列表
    system_message: str     # 系统提示词

class Message:
    role: str                # "user" | "assistant" | "system" | "tool"
    content: str             # 消息内容
    tool_calls: List[Dict]    # Function Call 信息（可选）
```

### 3.3 记忆查询流程

```
memory.query_memory(query)
    │
    ├─→ 提取查询关键词
    │
    ├─→ 搜索相关记忆
    │   └─→ 基于向量相似度或关键词匹配
    │
    └─→ 返回记忆上下文
        └─→ 格式: "相关记忆1\n相关记忆2\n..."
```

## 四、工具调用数据流

### 4.1 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  LLM 生成 Function Call                                     │
│  {                                                          │
│    "id": "call_xxx",                                        │
│    "function": {                                            │
│      "name": "get_weather",                                 │
│      "arguments": '{"location": "北京"}'                    │
│    }                                                        │
│  }                                                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  UnifiedToolHandler.handle_llm_function_call()              │
│  ├─→ 解析 function_name 和 arguments                        │
│  └─→ 如果 arguments 是字符串，解析为 JSON                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  ToolManager.execute_tool()                                 │
│  ├─→ 查找工具类型 (get_tool_type)                           │
│  └─→ 路由到对应执行器                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  ServerPlugin    │        │  DeviceIoT       │
│  Executor        │        │  Executor         │
│  - 服务端插件    │        │  - 设备IoT控制    │
└────────┬─────────┘        └────────┬─────────┘
         │                             │
         ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  DeviceMCP       │        │  ServerMCP        │
│  Executor        │        │  Executor         │
│  - 设备MCP工具   │        │  - 服务端MCP工具  │
└────────┬─────────┘        └────────┬─────────┘
         │                             │
         └───────────┬─────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│  执行器执行工具                                               │
│  └─→ executor.execute(conn, tool_name, arguments)           │
│      ├─→ 查找注册的函数                                       │
│      ├─→ 根据 ToolType 决定参数传递方式                       │
│      └─→ 调用函数并返回结果                                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  处理 ActionResponse                                        │
│  └─→ _handle_function_result()                              │
│      ├─→ Action.RESPONSE                                    │
│      │   └─→ 直接回复用户 (TTS)                              │
│      │                                                       │
│      ├─→ Action.REQLLM                                      │
│      │   ├─→ 将结果添加到对话历史                             │
│      │   └─→ 递归调用 chat(depth+1)                          │
│      │                                                       │
│      └─→ Action.ERROR                                       │
│          └─→ 错误处理                                        │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 工具执行器类型

| 执行器 | 工具类型 | 说明 |
|--------|---------|------|
| ServerPluginExecutor | SERVER_PLUGIN | 执行服务端插件函数 |
| DeviceIoTExecutor | DEVICE_IOT | 执行设备 IoT 控制 |
| DeviceMCPExecutor | DEVICE_MCP | 执行设备 MCP 工具 |
| ServerMCPExecutor | SERVER_MCP | 执行服务端 MCP 工具 |
| MCPEndpointExecutor | MCP_ENDPOINT | 执行 MCP 接入点工具 |

### 4.3 Action 类型说明

| Action | 说明 | 后续处理 |
|--------|------|---------|
| REQLLM | 需要 LLM 继续处理 | 递归调用 `chat(depth+1)` |
| RESPONSE | 直接回复用户 | 通过 TTS 直接回复 |
| ERROR | 执行出错 | 错误处理 |
| NOTFOUND | 未找到函数 | 错误提示 |

## 五、TTS 输出数据流

### 5.1 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  LLM 生成文本或工具返回文本                                   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  创建 TTSMessageDTO                                          │
│  └─→ TTSMessageDTO(                                         │
│      sentence_id=uuid,                                       │
│      sentence_type=FIRST/MIDDLE/LAST,                       │
│      content_type=TEXT/ACTION,                              │
│      content_detail="文本内容"                                │
│  )                                                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  TTS 文本队列                                                │
│  └─→ tts.tts_text_queue.put(message_dto)                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  TTS 处理线程                                                │
│  └─→ TTS 处理循环:                                           │
│      ├─→ 从队列获取文本                                      │
│      ├─→ 根据 sentence_type 处理                             │
│      │   ├─→ FIRST → 开始新句子                              │
│      │   ├─→ MIDDLE → 句子中间部分                           │
│      │   └─→ LAST → 句子结束                                 │
│      │                                                       │
│      └─→ 文本转语音                                          │
│          ├─→ 流式 TTS → 实时合成                             │
│          └─→ 非流式 TTS → 完整合成                           │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  音频编码                                                    │
│  └─→ 编码为 Opus 格式                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  TTS 音频队列                                                │
│  └─→ tts.tts_audio_queue.put((type, opus_packets, text))    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  发送到客户端                                                │
│  └─→ sendAudioHandle.send_audio()                           │
│      └─→ websocket.send(opus_packets)                        │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 TTS 消息类型

| SentenceType | 说明 | 使用场景 |
|-------------|------|---------|
| FIRST | 句子开始 | 新对话开始，发送开始标记 |
| MIDDLE | 句子中间 | 流式输出中间部分 |
| LAST | 句子结束 | 对话结束，发送结束标记 |

| ContentType | 说明 | 使用场景 |
|------------|------|---------|
| TEXT | 文本内容 | 正常的文本回复 |
| ACTION | 动作标记 | 开始/结束标记 |

## 六、记忆管理数据流

### 6.1 记忆保存流程

```
┌─────────────────────────────────────────────────────────────┐
│  对话结束或连接关闭                                           │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  ConnectionHandler._save_and_close()                         │
│  └─→ memory.save_memory(dialogue.dialogue)                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  本地记忆         │        │  远程记忆服务     │
│  (mem_local_     │        │  (mem0ai)        │
│   short)         │        │                  │
│                  │        │                  │
│  - 保存到文件    │        │  - API 调用      │
│  - JSON 格式     │        │  - 云端存储      │
└──────────────────┘        └──────────────────┘
```

### 6.2 记忆查询流程

```
memory.query_memory(query)
    │
    ├─→ 提取关键词
    │
    ├─→ 搜索相关记忆
    │   ├─→ 向量相似度搜索 (如果支持)
    │   └─→ 关键词匹配
    │
    └─→ 返回记忆上下文
        └─→ 格式: "记忆1\n记忆2\n..."
```

## 七、配置更新数据流

### 7.1 配置热更新流程

```
┌─────────────────────────────────────────────────────────────┐
│  定时任务或手动触发                                           │
│  └─→ WebSocketServer.update_config()                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  获取新配置                                                   │
│  └─→ get_config_from_api(config)                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  检查配置变化                                                 │
│  ├─→ check_vad_update(old_config, new_config)                │
│  └─→ check_asr_update(old_config, new_config)                │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  重新初始化模块                                               │
│  └─→ initialize_modules()                                   │
│      ├─→ 如果 VAD 类型变化 → 重新初始化 VAD                   │
│      ├─→ 如果 ASR 类型变化 → 重新初始化 ASR                   │
│      └─→ 更新其他模块配置                                     │
└─────────────────────────────────────────────────────────────┘
```

## 八、错误处理流程

### 8.1 异常捕获和处理

```
┌─────────────────────────────────────────────────────────────┐
│  任何模块执行                                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  try-except 捕获异常                                         │
│  └─→ 记录错误日志                                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐        ┌──────────────────┐
│  可恢复错误       │        │  严重错误         │
│                  │        │                  │
│  - 返回错误响应  │        │  - 关闭连接       │
│  - 继续处理      │        │  - 清理资源       │
└──────────────────┘        └──────────────────┘
```

## 九、性能优化点

1. **异步处理**: 所有 I/O 操作使用 asyncio
2. **流式处理**: ASR/TTS 支持流式，降低延迟
3. **连接级实例**: TTS/ASR 按连接创建，避免共享状态
4. **线程池**: CPU 密集型任务使用线程池
5. **缓存机制**: 记忆、IP 信息等使用缓存
6. **队列缓冲**: 使用队列缓冲音频和文本数据

## 十、关键时序图

### 10.1 完整对话时序

```
客户端          ConnectionHandler    ASR        LLM        TTS        工具
  │                    │             │          │          │          │
  │──音频数据─────────>│             │          │          │          │
  │                    │──音频──────>│          │          │          │
  │                    │             │          │          │          │
  │                    │<─识别结果────│          │          │          │
  │                    │             │          │          │          │
  │                    │──文本───────┼─────────>│          │          │
  │                    │             │          │          │          │
  │                    │             │          │──Function Call───>│
  │                    │             │          │<──结果──────────────│
  │                    │             │          │          │          │
  │                    │             │<──回复────│          │          │
  │                    │             │          │          │          │
  │                    │             │          │──文本───>│          │
  │                    │             │          │          │          │
  │<──音频数据─────────│             │          │          │          │
  │                    │             │          │          │          │
```

### 10.2 工具调用时序

```
LLM          UnifiedToolHandler    ToolManager    Executor    插件函数
 │                    │                  │            │            │
 │──Function Call────>│                  │            │            │
 │                    │                  │            │            │
 │                    │──执行工具────────>│            │            │
 │                    │                  │            │            │
 │                    │                  │──路由─────>│            │
 │                    │                  │            │            │
 │                    │                  │            │──调用─────>│
 │                    │                  │            │            │
 │                    │                  │            │<──结果──────│
 │                    │                  │            │            │
 │                    │<──ActionResponse─│            │            │
 │                    │                  │            │            │
 │<──继续处理──────────│                  │            │            │
 │                    │                  │            │            │
```

## 总结

本文档详细描述了小智服务器中各种数据流的处理过程。理解这些数据流有助于：

1. **调试问题**: 快速定位问题所在的数据流环节
2. **性能优化**: 识别性能瓶颈点
3. **功能扩展**: 了解在哪个环节添加新功能最合适
4. **架构理解**: 深入理解系统设计思路

建议结合 `ARCHITECTURE.md` 一起阅读，获得更全面的架构理解。

